<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="./pedals/css/shared-styles.html">
<link rel="import" href="./pedals/js/Pizzicato_2.html">

<link rel="import" href="./pedals/pedal-in.html">
<link rel="import" href="./pedals/pedal-out.html">
<link rel="import" href="./pedals/pedal-delay.html">
<link rel="import" href="./pedals/pedal-flanger.html">
<link rel="import" href="./pedals/pedal-lowpass.html">
<link rel="import" href="./pedals/pedal-quadrafuzz.html">
<link rel="import" href="./amp-sim/amp-sim.html">

<dom-module id="pedal-board">
  <template>
    <style>
       :host {
        background-color: maroon;
        background-image: url('../../img/background-pedalboard.jpg');
        /* background-image: url('http://media.istockphoto.com/illustrations/seamless-texture-1-credits-brick-wall-noise-effect-black-background-illustration-id164486066?k=6&m=164486066&s=612x612&w=0&h=WC2gMzgGDJTF0b8edB6l_jFYlpNggSsb1-I6oCBZ_Qo='); */
        transform: scale(1, 1);
        position: absolute;
        top: 0px;
        right: 0%;
        left: 0px;
        bottom: 0%;

        width: 100%;
        height: 100%;

        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        user-select: none;
        overflow: hidden
      }

      html,
      body {
        height: 100%;
      }

      body {
        background-image: url('../img/background.jpg');
      }
      /***** header *****/

      header,
      .div_app_tabs {
        background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.9));
        background: url(https://media.fabfab.net/images/products/250/15_10007_080.jpg);
        box-shadow: inset 0px 1px 10px 0px #111;
      }

      header {

        z-index: 1;

        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
      }

      header span,
      header a {
        color: #ccc;
        text-shadow: 0px -1px 0px #000;

        font-size: 20px;

        font-family: 'Quicksand', cursive;
        text-decoration: none;
      }

      header div {
        flex: 1;
        padding: 20px;

        text-align: center;
      }
      /*
      header div:nth-child(2){
        background: #111;
      }
      /**/

      header div audio {
        width: 100%;
      }
      /***** https://stackoverflow.com/questions/4126708/is-it-possible-to-style-html5-audio-tag *****/

      audio::-webkit-media-controls-panel,
      audio::-webkit-media-controls-current-time-display,
      audio::-webkit-media-controls-time-remaining-display {
        background: transparent;
        color: #888;
      }

      .pedals:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .pedals {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        cursor: pointer;

        padding: 10px;
        border-radius: 4px;
      }

      .pedals .pedal {
        height: 160px;
      }

      .pedals span {
        display: none;
        color: #eee;

        font-size: 14px;
        padding-top: 10px;

        font-family: 'Quicksand', cursive;
      }

      #delay {
        width: 109px;
        height: 159px;
        background-image: url("../../img/delay.png");
      }

      #quadrafuzz {
        width: 90px;
        height: 160px;
        background-image: url("../../img/quadra_fuzz.png");
      }

      #lowpass {
        width: 85px;
        height: 162px;
        background-image: url("../../img/low_pass.png");
      }

      #flanger {
        width: 150px;
        height: 162px;
        background-image: url("../../img/flanger.png");
      }


      #ampsim {
        width: 420px;
        height: 100px;
        background-image: url("../../img/ampsim.png");
        background-size: cover;
      }

      #ampsim img {
        width: 100%;
      }
      /***** div_app_tabs *****/

      .div_app_tabs {
        position: absolute;
        bottom: 0px;
        left: 0px;
        right: 0px;
        z-index: 1;

        padding: 10px;
        transition: 0.2s;
      }

      .div_app_tabs input[type=radio] {
        display: none;
      }

      .div_app_tabs input:hover+label {
        background: #222;
        border-top: 1px solid orange;
      }

      .div_app_tabs input:checked+label {
        background: #111;
        border-top: 1px solid purple;
      }

      .div_app_tabs label:hover {
        background: #222;
      }

      .div_app_tabs label {
        background: linear-gradient(#333, #111);
        color: #eee;
        border: 1px solid #111;

        padding: 10px;

        font-family: 'Quicksand', cursive;
        display: inline-block;
        cursor: pointer;
      }

      .div_app_tabs .div_container {
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 4px 5px 0 rgba(0, 0, 0, 0.06), 0 1px 10px 0 rgba(0, 0, 0, 0.08);

        height: 210px;
        padding: 10px;

        display: flex;
        flex-direction: column;
        justify-content: flex-start;
      }

      .div_app_tabs [id^="content-"] {
        display: none;
      }

      .div_app_tabs #tab-1:checked~.div_container #content-1,
      .div_app_tabs #tab-2:checked~.div_container #content-2,
      .div_app_tabs #tab-3:checked~.div_container #content-3,
      .div_app_tabs #tab-4:checked~.div_container #content-4,
      .div_app_tabs #tab-5:checked~.div_container #content-5 {
        display: flex;
      }

      .div_app_tabs #bt_hide_tabs:hover {
        background: #222;
      }

      .div_app_tabs #bt_hide_tabs {
        background: linear-gradient(#333, #111);
        color: #eee;
        border: 1px solid #111;

        position: absolute;
        top: 0px;
        right: 0px;

        padding: 10px;
        margin: 10px;

        cursor: pointer;
      }

      .bottomTabs {
        bottom: -230px !important;
      }

      @keyframes zoomeffect {
        0% {
          filter: blur(0px);
          transform: scale(1, 1);
        }
        50% {
          filter: blur(3px);
        }
        100% {
          filter: blur(0px);
          transform: scale(2, 2);
        }
      }

      @keyframes dezoomeffect {
        0% {
          filter: blur(0px);
          transform: scale(2, 2);
        }
        50% {
          filter: blur(3px);
        }
        100% {
          filter: blur(0px);
          transform: scale(1, 1);
        }
      }


      .context-menu {
        display: none;
        position: absolute;
        margin-top: 38px;
        margin-left: -15px;
        z-index: 10;
        padding: 12px 0;
        width: 70px;
        background: rgba(0, 0, 0, 0.3);
        border: solid 1px #dfdfdf;
        box-shadow: 1px 1px 2px #cfcfcf;
      }

      .context-menu--active {
        display: block;
      }

      .context-menu__items {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .context-menu__item1 {
        display: block;
        margin-left: 5px;
        padding: 0px 12px;
        width: 40px;
        height: 14px;
        background-repeat: no-repeat;
      }

      .context-menu__item1:last-child {
        margin-bottom: 0;
      }

      .context-menu__item1:hover {
        color: #fff;
        margin-left: 5px;
        background-image: url("../img/RightJackHover.png");
      }

      .context-menu__item2 {
        display: block;
        margin-left: 5px;
        padding: 0px 12px;
        width: 110px;
        height: 28px;
        background-repeat: no-repeat;
      }

      .context-menu__item2:last-child {
        margin-bottom: 0;
      }

      .context-menu__item2:hover {
        color: #fff;
        background-image: url("../img/RightJackHoverL.png");
      }
    </style>

    <header>
      <div><a href="https://github.com/dl100463/TER-Pedalboard-creation/tree/newBranchEK">PedalBoard 2017</a></div>
      <div>
        <audio src="./audio/BasketCase Greenday riff DI.mp3" id="soundSample" controls loop crossorigin="anonymous"></audio>
      </div>
      <div>
        <span>MICRO</span>
        <webaudio-switch src="img/switch_toggle.png" class="id" id="mic" height="28" width="50" alt="Press to record" title="Press to record"></webaudio-switch>
      </div>
    </header>

    <pedal-in id="pedalIn"></pedal-in>
    <pedal-out id="pedalOut"></pedal-out>

    <!-- appel des méthodes de la classe -->
    <slot id="slot" on-dragover="dragPedalHandler" on-drop="dropPedalHandler"></slot>
    <!-- autre façon d'appeler des méthodes de la classe -->
    <!--
    <slot id="slot" ondragover="[[dragPedalHandler]]" ondrop="[[dropPedalHandler]]"></slot>
    -->

    <div id="div_app_tabs" class="div_app_tabs">
      <div class="div_tabs" id="div_tabs">
        <input id="tab-1" type="radio" name="input-tab" checked><label for="tab-1">delay</label>
        <input id="tab-2" type="radio" name="input-tab"><label for="tab-2">lowpass</label>
        <input id="tab-3" type="radio" name="input-tab"><label for="tab-3">quadrafuzz</label>
        <input id="tab-4" type="radio" name="input-tab"><label for="tab-4">flanger</label>
        <input id="tab-5" type="radio" name="input-tab"><label for="tab-5">ampsim</label>

        <button id="bt_hide_tabs"><iron-icon icon="expand-more"></iron-icon></button>
        <div class="div_container">

          <div id="content-1">
            <div class="pedals">
              <div id="delay" class="pedal" draggable="true"></div>
              <span>delay</span>
            </div>
          </div>

          <div id="content-2">
            <div class="pedals">
              <div id="lowpass" class="pedal" draggable="true"></div>
              <span>lowpass</span>
            </div>
          </div>

          <div id="content-3">
            <div class="pedals">
              <div id="quadrafuzz" class="pedal" draggable="true"></div>
              <span>quadrafuzz</span>
            </div>
          </div>

          <div id="content-4">
            <div class="pedals">
              <div id="flanger" class="pedal" draggable="true"></div>
              <span>flanger</span>
            </div>
          </div>

          <div id="content-5">
            <div class="pedals">
              <div id="ampsim" class="pedal" draggable="true">
              </div>
              <span>ampsim</span>
            </div>
          </div>

        </div>
      </div>
    </div>


    <div>
      <nav id="context-menuJack" class="context-menu">
        <ul id="menu-container" class="context-menu__items">
        </ul>
      </nav>
    </div>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class PedalBoard extends Polymer.Element {

      static get is() {
        return 'pedal-board';
      }

      // 2 propriétés : width et height de la pedalboard
      static get properties() {
        return {
          dataWidth: {
            type: Number,
            value: 0
          },
          dataHeight: {
            type: Number,
            value: 0
          },
          soundSample: {
            type: Object,
            value: ""
          }
        };
      }

      constructor() {
        super();

        this.pedals = [];
        this.elem = document.querySelector("pedal-board");
        this.pIn;
        this.pOut;

        this.svgcanvas = undefined;

        this.currentState = "none";
        this.oldMousePosX = 0;
        this.oldMousePosY = 0;
        this.zoom = 0;
        this.menuState = 0;
        this.currentDraggablePedal = "";
        this.currentPedalOppened = "";
        this.pedalboardOrigin = [];

        this.nbPedalsAdded = 0;

        this.w = 0;
        this.h = 0;
        this.wO = 0;
        this.hO = 0;

        // ===== ===== SOUND ===== ===== 
        this.sound = {
          pzContext: null,
          mediaSource: null,
          audioDestination: null,
          mediaSourceM: null,
          mediaSRC: null,
          state: 0
        }
      }

      connectedCallback() {
        super.connectedCallback();
      }

      ready() {
        super.ready();

        this.soundSample = this.$.soundSample;
        this.w = this.offsetWidth;
        this.wO = this.w;

        this.h = this.offsetHeight;
        this.hO = this.h;


        this.pIn = this.$["pedalIn"];
        this.pOut = this.$["pedalOut"];

        // create SVG canvas
        this.svgcanvas = PedalBoard.createSVGcanvas(this.w, this.h);

        // Handles the WebAudio graph initialization
        this.soundHandler();

        // ajout des sources IN/OUT dans le pedalBoard
        this.pIn.setPosition(-20, (this.h / 2));
        this.pOut.setPosition(this.w, (this.h / 2));

        this.addPedal(this.pIn);
        this.addPedal(this.pOut);

        /*
        // ADD NEW PEDAL TO PEDALBOARD
        let p0 = document.createElement("amp-sim");
        p0.setPosition(450, 200);
        this.addPedal(p0);

        let p1 = document.createElement("pedal-delay");
        p1.setPosition(150, 600);
        this.addPedal(p1);

        let p2 = document.createElement("pedal-flanger");
        p2.setPosition(400, 400);
        this.addPedal(p2);

        let p3 = document.createElement("pedal-lowpass");
        p3.setPosition(700, 400);
        this.addPedal(p3);

        let p4 = document.createElement("pedal-quadrafuzz");
        p4.setPosition(150, 50);
        this.addPedal(p4);


        // CONNECT PEDALS
        this.connect(this.pIn, p0);
        this.connect(p1, p0);
        this.connect(p0, this.pOut);
        */


        // For pedals to be draggable
        this.addDraggableListeners();

        // For new pedals to be added
        this.addNewPedalListeners();

        // For mouse zooming 
        this.addZoomListener();

        this.resizeListener();


        this.addTabsListeners();
      }

      addPedal(p) {
        this.pedals.push(p);
        if (p.id != "pedalIn" && p.id != "pedalOut") {
          p.className = "draggable";
          p.id = "p" + this.nbPedalsAdded;
          this.nbPedalsAdded++;
        }
        p.pedalboard = this;
        this.appendChild(p);

        // For the jack menu to appear
        this.handleJackMenu(p);
      }

      removePedal(p) {
        if (confirm("Souhaitez-vous vraiment supprimer cette pédale ?")) {
          let jacksIn = p.inputJacks;
          let jacksOut = p.outputJacks;

          for (let i = jacksIn.length - 1; i >= 0; i--) this.disconnect(jacksIn[i].p1, jacksIn[i].p2);
          for (let i = jacksOut.length - 1; i >= 0; i--) this.disconnect(jacksOut[i].p1, jacksOut[i].p2);

          var index = this.pedals.indexOf(p);
          if (index > -1) this.pedals.splice(index, 1);
          this.removeChild(p);
        }
      }

      connect(p1, p2) {
        let j = new Jack();
        j.connexion(p1, p2);

        p1.addJackAtOutput(j);
        p2.addJackAtInput(j);
        this.soundNodeConnection(p1, p2);
      }

      disconnect(p1, p2) {
        let j;
        for (j in p1.outputJacks) {
          if (p1.outputJacks[j].p2 == p2) {
            p1.removeJackAtOutput(p1.outputJacks[j]);
          }
        }
        for (j in p2.inputJacks) {
          if (p2.inputJacks[j].p1 == p1) {
            p2.removeJackAtInput(p2.inputJacks[j]);
          }
        }

        // removes all components of the SVG Jack, 
        // here 3 drawings on top of each other
        for (var i = 1; i <= 4; i++) {
          var elem = document.getElementById("jack_" + p1.id + "_" + p2.id + "_" + i);
          if (elem != null) elem.parentNode.removeChild(elem);
        }

        this.soundNodeDisconnection(p1, p2);
      }

      getPedalFromHtmlElem(elem) {
        for (var i = 0; i < this.pedals.length; i++) {
          var p = this.pedals[i];
          if (p === elem) return p;
        }
        return undefined;
      }

      move(dx, dy) {
        if (this.zoom == 1) {
          this.style.transition = '';
          this.pedalboardOrigin.x += dx / 50;
          this.pedalboardOrigin.y += dy / 50;
          this.style.transform = "scale(2,2) translate(" + this.pedalboardOrigin.x + "px," + this.pedalboardOrigin
            .y +
            "px)";
        }

      }

      findClosestIO(x, y) {
        this.pedals.forEach((p) => {
          /*
          be careful here this is not the pedalboard,
          we're in a forEach callback, remind the trap
          I talked into the course !!!! 
          This is why we use self = this just before !
          */
          let iPos = p.getInputPos();
          let oPos = p.getOutputPos();

          let distInput;
          let distMinToInputForHighlight = 20;

          if (this.currentState === "drawingNewJack") {
            /*
            We must highlight the pedal input taking
            into account the length of the jack ending (an image of 100px width)
            */
            distInput = this.distance(x, y, iPos.x - 100, iPos.y);
            distMinToInputForHighlight = 100;
          } else {
            // regular case, we're just pointing the mouse around
            distInput = this.distance(x, y, iPos.x, iPos.y);
          }

          let distOutput = this.distance(x, y, oPos.x, oPos.y);
          // It depends if we're trying to plug a jack or not
          if (distInput < distMinToInputForHighlight) {
            if (!p.inputHighlighted) p.highLightInput(true);
          } else {
            if (p.inputHighlighted) p.highLightInput(false);
          }

          if (distOutput < 40) {
            if (!p.outputHighlighted) p.highLightOutput(true);
          } else {
            if (p.outputHighlighted) p.highLightOutput(false);
          }
        });
      }

      findPedalWhoseOutputIsHighlighted() {
        for (let i = 0; i < this.pedals.length; i++) {
          let p = this.pedals[i];
          if (p.outputHighlighted) return p;
        }
      }

      findPedalWhoseInputIsHighlighted() {
        for (var i = 0; i < this.pedals.length; i++) {
          let p = this.pedals[i];
          if (p.inputHighlighted) return p;
        }
      }

      rescale(s) {
        this.style = 'transform(' + s + ',' + s + ')';
      }

      dblclickHandler(e) {
        e.preventDefault();
        let boardWid = parseInt(window.getComputedStyle(this).width, 10);
        let boardHei = parseInt(window.getComputedStyle(this).height, 10);
        let zoomPosH = "bottom";
        let zoomPosW = "right";
        let animationName = "dezoomeffect";
        if (this.zoom == 0) {
          if (e.clientX <= (boardWid / 3)) zoomPosW = "left";
          else if (e.clientX > (boardWid / 3) && e.clientX < ((2 * boardWid) / 3)) zoomPosW = "center";

          if (e.clientY <= (boardHei / 3)) zoomPosH = "top";
          else if (e.clientY > (boardHei / 3) && e.clientY < ((2 * boardHei) / 3)) zoomPosH = "center";

          this.style.transformOrigin = zoomPosW + " " + zoomPosH;
          animationName = "zoomeffect";
          this.zoom = 1;
        } else {
          this.zoom = 0;
        }
        this.style.animation = animationName + ' 0.1s ease-out';
        this.style.animationFillMode = 'forwards';
        //this.zoom = !this.zoom;
      }


      mouseWheelHandler(e) {
        e.preventDefault();

        let board = document.querySelector('#pedalboard');
        let boardC = document.querySelector('#pedalboard-container');
        let boardWid = parseInt(window.getComputedStyle(board).width, 10);
        let boardHei = parseInt(window.getComputedStyle(board).height, 10);

        let delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));

        if (delta == 1) {
          this.zoom = 1;
          board.style.transform = 'scale(2,2)';
          board.style.transition = 'transform 0.5s ease-in';

          if (e.clientY < boardHei / 3) {
            if (e.clientX < boardWid / 3) {
              board.style.transformOrigin = 'left top';
            } else if (e.clientX < 2 * (boardWid / 3)) {
              board.style.transformOrigin = 'center top';
            } else {
              board.style.transformOrigin = 'right top';
            }
          } else if (e.clientY < 2 * (boardHei / 3)) {
            if (e.clientX < boardWid / 3) {
              board.style.transformOrigin = 'left center';
            } else if (e.clientX < 2 * (boardWid / 3)) {
              board.style.transformOrigin = 'center center';
            } else {
              board.style.transformOrigin = 'right center';
            }
          } else {
            if (e.clientX < boardWid / 3) {
              board.style.transformOrigin = 'left bottom';
            } else if (e.clientX < 2 * (boardWid / 3)) {
              board.style.transformOrigin = 'center bottom';
            } else {
              board.style.transformOrigin = 'right bottom';
            }
          }
        }

        if (delta == -1) {
          this.zoom = 0;
          board.style.transform = 'scale(1,1)';
          board.style.transition = 'transform 0.5s ease-in';
          pedalboard.pedalboardOrigin.x = 0;
          pedalboard.pedalboardOrigin.y = 0;
        }
      }

      highlightInputsOutputs(e) {
        let rect = this.getBoundingClientRect();
        let mouseX = e.x - rect.left;
        let mouseY = e.y - rect.top;
        let closest = this.findClosestIO(mouseX, mouseY);
      }

      addTabsListeners() {
        this.$.bt_hide_tabs.addEventListener("click", () => {
          if (this.$.div_app_tabs.classList.contains("bottomTabs")) {
            this.$.bt_hide_tabs.querySelector("iron-icon").setAttribute("icon", "expand-more");
            this.$.div_app_tabs.classList.remove("bottomTabs");
          } else {
            this.$.div_app_tabs.className += " bottomTabs";
            this.$.bt_hide_tabs.querySelector("iron-icon").setAttribute("icon", "expand-less");
          }
        });
      }

      handleJackMenu(p) {
        // clique sur input
        let input = "";
        p.inputP.addEventListener("click", (e) => {
          e.preventDefault();
          input = p.inputP;
          this.currentPedalOppened = p;
          if (input.getAttribute("open") && (input.getAttribute("open") == 'true')) {
            input.setAttribute("open", false);
          } else {
            input.setAttribute("open", true);
            // si nombre de jacks > 1
          }
          if (p.inputJacks.length > 1) {
            // création du menu items
            this.createMenuItems(p.inputJacks, input.getAttribute("open") === 'true');
            //this.toggleMenuOn();
            //this.positionMenu(e, p);
          }
        });
      }

      createMenuItems(jacks, open) {
        let len = jacks.length;
        let offsetY = 0;
        /*
        this.$["menu-container"].innerHTML = "";
        let newMenuWid = 70 * (1 + this.zoom);
        let menu = this.$["context-menuJack"];
        menu.style.width = "" + newMenuWid + "px";
        this.root.querySelector(".context-menu__items").style.width = "" + newMenuWid + "px";

        // Approximatively adapts the Y position where the jacks in menu start
        // according to the number of jacks plugged in the pedal, since the
        // menu adapts its position according to the number of item

        if (this.zoom == 1) {
          if (board.style.transformOrigin == 'left top 0px' || board.style.transformOrigin == 'center top 0px' ||
            board.style.transformOrigin == 'right top 0px') {
            offsetY -= 2.5;
          }
          if (board.style.transformOrigin == 'left bottom 0px' || board.style.transformOrigin ==
            'center bottom 0px' || board.style.transformOrigin == 'right bottom 0px') {
            offsetY += 2.5;
          }
        }

        */

        jacks.forEach((j) => {
          /*

          // Adds a menu item for each jack in the pedal
          let ul = this.$["menu-container"];
          let li = document.createElement("li");
          li.appendChild(document.createTextNode("")); //"Jack " + j.p1.id.substring(5,6)));
          li.setAttribute("id", "jack" + j.p1.id.substring(5, 6));
          this.zoom == 0 ? li.classList.add("context-menu__item1") : li.classList.add("context-menu__item2");
            
          // let menuItemWid = 40 * (1 + (zoom * 2));
          // let menuItemHei = 14 * (zoom + 1);
          // li.style = "width:"+ menuItemWid +"px; height: "+ menuItemHei +"px";

          ul.appendChild(li);
          */

          // Repositions the current jack so that it feels like it's unplugged 
          // while in the opened menu
          j.repositionJack(offsetY, open);
          if (open) offsetY += 20;
          else offsetY -= 0;

          /*
          li.addEventListener("mousedown", function (e) {
            // Computes the location of the mouse in the SVG canvas
            var loc = cursorPoint(e);

            e.preventDefault();
            e.stopPropagation();
            // first we disconnect the jack before immediatly creating
            // a new one to drag
            pedalboard.disconnect(j.p1, j.p2);
            pedalboard.currentState = "drawingNewJack";
            let x1 = j.p1.getOutputPos().x;
            let y1 = j.p1.getOutputPos().y;
            let x2 = j.p2.getInputPos().x;
            let y2 = j.p2.getInputPos().y;

            pedalboard.currentDraggableJack = createBezierSVGJack("tmpJack", x1, y1, loc.x, loc.y);
            pedalboard.currentDraggableJack.end.setAttribute("x", loc.x - 7);
            pedalboard.currentDraggableJack.end.setAttribute("y", loc.y - 10);
            pedalboard.currentDraggableJack.sourcePedal = j.p1;
            pedalboard.currentDraggableJack.x1 = x1;
            pedalboard.currentDraggableJack.y1 = y1;
            toggleMenuOff();
            // we update the position of the jack because the default toggle
            // moved the jack back to the menu
            window.addEventListener('mousemove', mouseMoveDraggable, true);
          })
            */
        })

      }

      addZoomListener() {
        // IE9, Chrome, Safari, Opera
        //this.addEventListener("mousewheel", this.mouseWheelHandler, false);
        // Firefox
        //this.addEventListener("DOMMouseScroll", this.mouseWheelHandler, false);

        this.addEventListener("dblclick", this.dblclickHandler, false);
      }

      static createSVGcanvas(w, h) {
        let svg = document.getElementById("svg-canvas");
        if (null == svg) {
          svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("id", "svg-canvas");
          svg.setAttribute('style', 'position:absolute;top:0px;left:0px');
          // Should use here pedalboard
          svg.setAttribute('width', w);
          svg.setAttribute('height', h);
          svg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");

          pedalboard.prepend(svg);
        }
        return svg;
      }

      updateSVGcanvas(w, h) {
        let svg = document.getElementById("svg-canvas");
        svg.setAttribute('width', w);
        svg.setAttribute('height', h);
      }

      distance(x1, y1, x2, y2) {
        var dx = x1 - x2;
        var dy = y1 - y2;

        return Math.sqrt(dx * dx + dy * dy);
      }

      /************* DRAGGABLE ********************/
      addDraggableListeners() {
        window.addEventListener('mousedown', this.mouseDownDraggable.bind(this), false);
        window.addEventListener('mouseup', this.mouseUpDraggable.bind(this), false);
        // celui-là pour detecter si on est au voisinage des inputs et outputs des pédales
        this.addEventListener('mousemove', this.highlightInputsOutputs.bind(this), false);
      }

      cursorPoint(evt) {
        let svg = document.querySelector('#svg-canvas');
        let pt = svg.createSVGPoint();
        pt.x = evt.clientX;
        pt.y = evt.clientY;
        return pt.matrixTransform(svg.getScreenCTM().inverse());
      }

      removeJack(loc, sourcePedal) {
        let x1 = sourcePedal.getOutputPos().x;
        let y1 = sourcePedal.getOutputPos().y;
        let _pos = {
          x1: x1,
          y1: y1,
          x2: loc.x,
          y2: loc.y
        }

        let j = new Jack();

        // currentDraggableJack
        let cDJ = j.reviewSVGJack(_pos, "tmpJack");
        cDJ.sourcePedal = sourcePedal;
        cDJ.end.setAttribute("x", loc.x - 7);
        cDJ.end.setAttribute("y", loc.y - 10);
        cDJ.x1 = x1;
        cDJ.y1 = y1;

        return cDJ;
      }

      mouseDownDraggable(e) {
        // Computes the location of the mouse in the SVG canvas
        var loc = this.cursorPoint(e);

        // e.preventDefault();
        // e.stopPropagation();

        // Quand on clique on mémorise : 1) l'ancienne position
        // de l'objet qu'on draggue et 2) l'ancienne position de
        // la souris (la position cliquee) et 3) on ajoute un 
        // mousemove listener
        let p;
        window.addEventListener('mousemove', this.mouseMoveDraggable.bind(this), true);

        if (e.target.id.startsWith("jack_")) {
          // pedale
          p = this.currentPedalOppened;
          let sourcePedal = "";
          // id du img#end jack = e.target.id
          for (var i = 0; i < p.inputJacks.length; i++) {
            if (p.inputJacks[i].end.id == e.target.id) {
              this.currentDraggableJack = p.inputJacks[i];
              sourcePedal = p.inputJacks[i].p1;
              break;
            }
          }
          this.currentState = "drawingNewJack";
          this.disconnect(sourcePedal, p);
          this.currentDraggableJack = this.removeJack(loc, sourcePedal);

        } else if ((p = this.findPedalWhoseOutputIsHighlighted()) !== undefined) {
          // an output of a pedal is selected, if we drag the mouse
          // we're in the process of dragging a new cable/jack
          this.currentState = "drawingNewJack";
          this.currentDraggableJack = this.removeJack(loc, p);

        } else if ((p = this.findPedalWhoseInputIsHighlighted()) !== undefined) {
          //pedalMenu = p;
          if (p.inputJacks.length == 1) {
            let sourcePedal = p.inputJacks[0].p1;
            // first we disconnect the jack before immediatly creating
            // a new one to drag
            this.currentState = "drawingNewJack";
            this.disconnect(sourcePedal, p);
            this.currentDraggableJack = this.removeJack(loc, sourcePedal);
          }
        } else if (this.clickInPedal(e)) {
          // dragging a pedal
          this.currentState = "draggingPedal";

          let draggableElementClicked = e.target;
          this.currentDraggablePedal = this.getPedalFromHtmlElem(draggableElementClicked);
          let p = this.currentDraggablePedal;

          if (p === undefined) return;

          p.beforeDragPosX = draggableElementClicked.offsetLeft;
          p.beforeDragPosY = draggableElementClicked.offsetTop;

        } else if (loc.x < parseInt(window.getComputedStyle(this).width, 10) &&
          loc.y < parseInt(window.getComputedStyle(this).height, 10)) {
          // dragging the pedalboard
          this.currentState = "draggingPedalboard";
        }
        // Keep track of mouse clicked pos (source position)
        this.oldMousePosX = loc.x;
        this.oldMousePosY = loc.y;
      }

      clickInPedal(e) {
        let loc = this.cursorPoint(e);
        let result = false;
        let pedal;

        this.pedals.forEach((pedal) => {
          //pedal = _p.getPedalFromHtmlElem(d);
          if (loc.x > pedal.x && loc.x < pedal.x + pedal.w * 1.25 && loc.y > pedal.y && loc.y < pedal.y +
            pedal
            .h * 1.25) {
            result = true;
          }
        });
        return result;
      }

      mouseUpDraggable() {
        // Une fois que la souris est relachée, on a plus besoin de l'évènement "mousemove", on le supprime
        window.removeEventListener('mousemove', this.mouseMoveDraggable.bind(this), true);
        let p;
        switch (this.currentState) {
          // on vient de déplacer un jack
          case "drawingNewJack":
            {
              // Remove current tmp jack
              for (var i = 1; i <= 4; i++) {
                var elem = document.querySelector("#tmpJack_" + i);
                elem.parentNode.removeChild(elem);
              }

              if ((p = this.findPedalWhoseInputIsHighlighted()) !== undefined) {
                // we are dragging a new Jack and we have the mouse pointer
                // close to a pedal input: let's connect the Jack !
                let already = false;
                for (var i = 0; i < p.inputJacks.length; i++) {
                  // checks if the jack is already plugged in by checking if the source
                  // pepdal already is in the inputJack list of the destination pedal                
                  if (p.inputJacks[i].p1 == this.currentDraggableJack.sourcePedal) {
                    already = true;
                  }
                }
                if (!already) this.connect(this.currentDraggableJack.sourcePedal, p);
              }
              delete this.currentDraggableJack;
            }
            break;
            // on vient de déplacer une pédale
          case "draggingPedal":
            break;
          case "draggingPedalboard":
            break;
        }
        // set back pedalboard state to "none", we finished a drag
        this.currentState = "none";
      }

      mouseMoveDraggable(e) {
        // Computes the location of the mouse in the SVG canvas
        var loc = this.cursorPoint(e);
        // deplacement souris incrémental
        let dx = (e.clientX - this.oldMousePosX);
        let dy = (e.clientY - this.oldMousePosY);
        switch (this.currentState) {
          case "drawingNewJack":
            {
              let jackWeAreDragging = this.currentDraggableJack;
              let _pos = {
                x1: jackWeAreDragging.x1,
                y1: jackWeAreDragging.y1,
                x2: loc.x,
                y2: loc.y
              };
              jackWeAreDragging.reviewSVGJack(_pos);
            }
            break;
          case "draggingPedal":
            {
              // test obligatoire car on pourrait cliquer
              // sur les input ou output ou boutons rotatifs etc.*
              if (this.currentDraggablePedal !== undefined && this.currentDraggablePedal.classList.contains(
                  'draggable')) {
                let p = this.currentDraggablePedal;
                p.move(p.beforeDragPosX + dx, p.beforeDragPosY + dy);
              }
            }
            break;
          case "draggingPedalboard":
            {
              this.move(dx, dy);
            }
            break;
        }
      }

      addNewPedalListeners() {
        var newPedals = this.root.querySelectorAll(".pedal");

        newPedals.forEach((p) => {
          p.addEventListener('dragstart', this.pedalDragStart, false);
        });
      }

      pedalDragStart(event) {
        event.dataTransfer.setData("pedalId", event.target.id);
      }

      resizeListener() {
        let dx, dy;
        window.onresize = (e) => {
          // Hide menu if the window is resized
          //toggleMenuOff();

          // Repositions the pedal located on the right 
          // according to the new width

          /*
          let pdbW = parseInt(window.getComputedStyle(pdb).width, 10);
          let pdbH = parseInt(window.getComputedStyle(pdb).height, 10);
          this.pedals[1].move(pdbW, -20 + (pdbH / 2));
          */
          this.w = this.offsetWidth;
          this.h = this.offsetHeight;
          this.pOut.setPosition(this.w, (this.h / 2));

          // produit en croix
          this.pedals.forEach((p, i) => {
            if (i > 1) {
              dx = ((p.offsetLeft) * (this.w)) / (this.wO);
              dy = ((p.offsetTop) * (this.h)) / (this.hO);
              p.move(dx, dy);
              /*
              p.inputJacks.forEach((j, k) => {
                j.update();
              });
              */
            }
          });

          this.wO = this.w;
          this.hO = this.h;

          this.updateSVGcanvas(this.w, this.h);
        }
      }


      /***** SOUND *****/
      soundHandler() {
        this.sound.pzContext = Pizzicato.context;
        //this.sound.pzContext = new AudioContext();
        this.sound.mediaSource = this.sound.pzContext.createMediaElementSource(this.soundSample);
        this.sound.audioDestination = this.sound.pzContext.destination;

        if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({
            audio: {
              latency: 0,
              echoCancellation: false,
              mozNoiseSuppression: false,
              mozAutoGainControl: false
            }
          }).then((stream) => {
            this.sound.mediaSourceM = this.sound.pzContext.createMediaStreamSource(stream);
          }).catch(function (err) {
            // handle the error
            console.log(err.name + ": " + err.message);
          });
        }

        // CHANGE STATE MIC(1) -> DEMO SOUND (0)
        var mic = this.$.mic;
        mic.addEventListener("change", (e) => {
          if (this.sound.state == 0) {
            if (this.pedals[0].outputJacks.length != 0) {
              this.pedals[0].outputJacks.forEach((j) => {
                this.soundNodeDisconnection(j.p1, j.p2);
                this.sound.state = 1;
                this.soundNodeConnection(j.p1, j.p2);
                // this.sound.state goes back to 0 for the next disconnect
                this.sound.state = 0;
              })
            }
            this.sound.state = 1;
          } else {
            if (this.pedals[0].outputJacks.length != 0) {
              this.pedals[0].outputJacks.forEach((j) => {
                this.soundNodeDisconnection(j.p1, j.p2);
                this.sound.state = 0;
                this.soundNodeConnection(j.p1, j.p2);
                // this.sound.state goes back to 1 for the next disconnect
                this.sound.state = 1;
              })
            }
            this.sound.state = 0;
          }
        })
      }

      soundNodeConnection(p1, p2) {
        if (p1.id == "pedalIn" && p2.id == "pedalOut") {
          if (this.sound.state == 0) {
            this.sound.mediaSource.connect(this.sound.audioDestination);
          } else {
            this.sound.mediaSourceM.connect(this.sound.audioDestination);
          }
        } else if (p1.id == "pedalIn") {
          if (this.sound.state == 0) {
            this.sound.mediaSource.connect(p2.elem.soundNodeIn);
          } else {
            this.sound.mediaSourceM.connect(p2.elem.soundNodeIn);
          }
        } else if (p2.id == "pedalOut") {
          p1.elem.soundNodeOut.connect(this.sound.audioDestination);
        } else {
          p1.elem.soundNodeOut.connect(p2.elem.soundNodeIn);
        }
      }

      soundNodeDisconnection(p1, p2) {
        if (p1.id == "pedalIn" && p2.id == "pedalOut") {
          if (this.sound.state == 0) {
            this.sound.mediaSource.disconnect(this.sound.audioDestination);
          } else {
            this.sound.mediaSourceM.disconnect(this.sound.audioDestination);
          }
        } else if (p1.id == "pedalIn") {
          if (this.sound.state == 0) {
            this.sound.mediaSource.disconnect(p2.elem.soundNodeIn);
          } else {
            this.sound.mediaSourceM.disconnect(p2.elem.soundNodeIn);
          }
        } else if (p2.id == "pedalOut") {
          p1.elem.soundNodeOut.disconnect(this.sound.audioDestination);
        } else {
          p1.elem.soundNodeOut.disconnect(p2.elem.soundNodeIn);
        }
      }

      dragPedalHandler(e) {
        e.preventDefault();
        return false;
      }

      dropPedalHandler(e) {
        let id = e.dataTransfer.getData("pedalId");
        let _id;
        // ICI GENERER UN ID UNIQUE !!! il peut y avoir plusieurs instances
        // de la même pédale
        if (id == "delay" || id == "flanger" || id == "lowpass" || id == "quadrafuzz") {
          _id = "pedal-" + id;
        } else if (id == "ampsim") {
          _id = "amp-sim";
        }
        let p = document.createElement(_id);
        // if (id == "ampsim") p.showEqualizer = true;

        p.setPosition(e.clientX - 30 - (p.dataWidth / 2), event.clientY - 10 - (p.dataHeight / 2));
        this.addPedal(p);
      }
    }

    class Jack {
      constructor() {
        this.j = "";
      }
      connexion(pedal1, pedal2) {
        this.p1 = pedal1;
        this.p2 = pedal2;

        // Compute the svg for this jack
        let oPos = pedal1.getOutputPos();
        let x1 = oPos.x,
          y1 = oPos.y;

        let iPos = pedal2.getInputPos();
        let x2 = iPos.x,
          y2 = iPos.y;

        this.id = "jack_" + pedal1.elem.id + "_" + pedal2.elem.id;

        this.shape1 = "";
        this.shape2 = "";
        this.shape3 = "";
        this.end = "";

        let _pos = {
          x1: x1,
          y1: y1,
          x2: x2,
          y2: y2
        }
        this.reviewSVGJack(_pos, this.id);

        /*
        // Compute the svg for this jack
        // position des cables à partir des input/output + rayon de l'input/ouput = 10px
        let oPosP1=p1.getOutputPos();
        let oPosP2=p2.getOutputPos();

        let x1 = oPosP1.x, y1 = oPosP1.y+10;
        let x2 = oPosP2.x-20, y2 = oPosP2.y+10;
        let jackSVG = this.createBezierSVGJack(this.svgCanvas,"jack_" + p1.id+"-"+ p2.id+"_", x1, y1, x2, y2);
        */
      }

      update() {
        let oPos = this.p1.getOutputPos();
        let x1 = oPos.x,
          y1 = oPos.y;
        let iPos = this.p2.getInputPos();
        let x2 = iPos.x,
          y2 = iPos.y;

        let _pos = {
          x1: x1,
          y1: y1,
          x2: x2,
          y2: y2
        }

        this.reviewSVGJack(_pos);
      }

      repositionJack(offsetY, open) {
        let pedalboard = this.p1.pedalboard;
        let posPedal1 = this.p1.getOutputPos();
        let posPedal2 = this.p2.getInputPos();
        // let wid = parseInt(pedalboard.$['context-menuJack'].style.width, 10);
        let wid = 0;
        if (open) wid = 70;
        let offestX = -(wid / (pedalboard.zoom + 1));
        let _pos = {
          x1: posPedal1.x,
          y1: posPedal1.y,
          x2: (posPedal2.x + offestX),
          y2: (posPedal2.y + offsetY)
        }
        this.reviewSVGJack(_pos);
      }


      /*
      From: http://stackoverflow.com/questions/6701705/programmatically-creating-an-svg-image-element-with-javascript
      I've been using the function bellow to create SVG elements and it was failing on create 
      images because of the xlink:href.

      The code bellow is corrected to do that (create any svg element on the fly)

      makeSVG('#map-tiles', 'image', { class:'map-tile', 'xlink:href':'map/xxx.jpg', width:'512px', height: '512px', x:'0', y:'0'});
      */
      // pour créer l'embout du cable
      makeSVG(tag, attrs) {
        var el = document.createElementNS('http://www.w3.org/2000/svg', tag);
        for (var k in attrs) {
          if (k == "xlink:href") el.setAttributeNS('http://www.w3.org/1999/xlink', 'href', attrs[k]);
          else el.setAttribute(k, attrs[k]);
        }
        return el;
      }

      /*
       * Si _id est définie alors on créer un nouveau câble, sinon on met à jour seulement
       */
      reviewSVGJack(_pos, _id) {
        let tension = 1;
        // if pedal 2 on the left of pedal 1
        if (_pos.x2 < _pos.x1) tension = -tension;

        let delta = (_pos.x2 - _pos.x1) * tension;

        let hx1 = _pos.x1 + delta;
        let hy1 = _pos.y1;
        let hx2 = _pos.x2 - delta;
        let hy2 = _pos.y2;

        let path = "M " + _pos.x1 + " " + _pos.y1 + " C " + hx1 + " " + hy1 + " " + hx2 + " " + hy2 +
          " " + _pos.x2 + " " + _pos.y2;
        let svg = PedalBoard.createSVGcanvas(this.w, this.h);
        if (_id) {
          this.shape1 = document.createElementNS("http://www.w3.org/2000/svg", "path");
          this.shape2 = document.createElementNS("http://www.w3.org/2000/svg", "path");
          this.shape3 = document.createElementNS("http://www.w3.org/2000/svg", "path");

          // External wire
          this.shape1.setAttributeNS(null, "fill", "none");
          this.shape1.setAttributeNS(null, "stroke", "#471221");
          this.shape1.setAttributeNS(null, "stroke-width", 10);
          this.shape1.setAttributeNS(null, "class", "wire");
          this.shape1.setAttributeNS(null, "id", _id + "_1");

          // Main colored mid wire
          this.shape2.setAttributeNS(null, "fill", "none");
          this.shape2.setAttributeNS(null, "stroke", "#8e457d");
          this.shape2.setAttributeNS(null, "stroke-width", 6);
          this.shape2.setAttributeNS(null, "class", "wire");
          this.shape2.setAttributeNS(null, "id", _id + "_2");

          // Specular color in the middle
          this.shape3.setAttributeNS(null, "fill", "none");
          this.shape3.setAttributeNS(null, "stroke", "#b87595");
          this.shape3.setAttributeNS(null, "stroke-width", 2);
          this.shape3.setAttributeNS(null, "class", "wire");
          this.shape3.setAttributeNS(null, "id", _id + "_3");

          // Jack ends are images (embout) 
          this.end = this.makeSVG('image', {
            class: 'map-tile',
            'xlink:href': 'http://img4.hostingpics.net/pics/146380rightJack.png',
            width: '100px',
            height: '20px',
            id: _id + "_4"
          });

          svg.appendChild(this.shape1);
          svg.appendChild(this.shape3);
          svg.appendChild(this.shape2);
          svg.appendChild(this.end);
        }

        this.shape1.setAttribute("d", path);
        this.shape2.setAttribute("d", path);
        this.shape3.setAttribute("d", path);
        this.end.setAttribute("x", _pos.x2 - 10);
        this.end.setAttribute("y", _pos.y2 - 10);
        return this;
      }
    }
    window.customElements.define(PedalBoard.is, PedalBoard);
  </script>
</dom-module>